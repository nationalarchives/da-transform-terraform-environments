policies:
  - name: ec2-tag
    description: |
      Adds a tag to EC2 instances
    resource: aws.ec2
    filters:
      - "tag:custodian-status": absent
    actions:
      - type: tag
        tags:
          custodian-status: 'discovered'
  - name: iam-instance-profiles-not-in-use
    resource: iam-profile
    mode:
      type: periodic
      schedule: "rate(5 day)"
      role: terraform
    filters:
      - type: unused
  - name: iam-policy-unused
    resource: iam-policy
    filters:
      - type: unused
  - name: iam-expired-access-keys
    resource: iam-user
    filters:
      - type: access-key
        key: Status
        value: Active
      - type: access-key
        match-operator: and
        key: CreateDate
        value_type: age
        value: 90
    actions:
      - type: tag
        tags:
          custodian-lifecycle: 'expired'
  - name: user-without-mfa
    resource: iam-user
    filters:
      - type: credential
        key: mfa_active
        value: false
  - name: dormant-users
    resource: iam-user
    filters:
      - type: credential
        key: password_last_used
        value_type: age
        value: 30
        op: greater-than
      - type: credential
        key: user_creation_time
        value_type: age
        value: 30
        op: greater-than
  - name: active-users
    resource: iam-user
    filters:
      - type: credential
        key: mfa_active
        value: true
      - type: credential
        key: password_enabled
        value: true
      - type: credential
        key: password_last_used
        value_type: age
        value: 30
        op: le
  - name: s3-check-for-public-access-block
    mode:
      type: periodic
      schedule: "rate(5 day)"
      role: terraform
    resource: aws.s3
    description: |
      Scans all S3 buckets for public access block and sets block if not present
    filters:
      - type: check-public-block
    actions:
      - type: notify
        slack_template: slack_default
        violation_desc: "S3 bucket missing public access block"
        action_desc: "Public access block added to S3 bucket permissions"
        to:
          - rahmed@zaizi.com

        transport:
          type: sns
          topic: test
