version: 0.2

phases:
  pre_build:
    commands:
      - aws --version
      - aws configure --profile temp set credential_source EcsContainer
      - export AWS_PROFILE=temp
      - aws sts get-caller-identity

  build:
    commands:
      - cd codepipeline/lambda-deploy
      - pip install -r requirements.txt
      - pipeline_name=terraform-dev
      - |
          if exec_id="$(
            aws codepipeline start-pipeline-execution \
              --name "${pipeline_name}" \
              --region eu-west-2 \
              --output text
          )"; then
            ./codepipeline_await.py "${pipeline_name}" "${exec_id}" --attempt_count 180 --wait_seconds 5
          fi
